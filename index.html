<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gleichungstrainer</title>
<style>
  body{
    font-family:system-ui,Arial,sans-serif;
    margin:0;
    padding:18px;
    text-align:center;
    background:linear-gradient(to bottom right,#eef2ff,#e0f7fa);
    font-size:18px;
  }

  #equation{
    font-size:1.9em;
    margin:0 auto 20px;
    font-weight:bold;
  }

  #stepsBox{
    margin:0 auto;
    max-width:900px;
    background:#ffffffcc;
    border-radius:16px;
    padding:22px;
    text-align:left;
  }

  .stepRow{
    margin:16px 0 20px;
  }
  .stepTitle{
    font-weight:bold;
    color:#007bff;
    font-size:1.15em;
    margin-bottom:10px;
  }

  .stepLine{
    display:flex;
    align-items:center;
    gap:10px;
  }

  .stepInput{
    flex:1;
    box-sizing:border-box;
    padding:10px 12px;
    font-size:1.1em;
    border-radius:10px;
    border:1px solid #888;
    font-family:monospace;
  }

  .eqSign{
    font-size:1.5em;
    font-weight:bold;
  }

  button{
    background:#007bff;
    color:white;
    border:none;
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer;
    font-size:1.05em;
  }

  .fb{
    font-size:1em;
    margin-top:4px;
    min-height:1.4em;
  }
  .ok{color:#2e7d32;}
  .err{color:#c62828;}

  #newEqBtn{
    display:block;
    margin:10px auto 0;
    padding:12px 20px;
    font-size:1.2em;
  }
</style>
</head>
<body>

<div id="equation">Lade Aufgabe ...</div>

<div id="stepsBox">

  <!-- Schritt 1 -->
  <div class="stepRow">
    <div class="stepTitle">1. Gleichartige Glieder ordnen</div>
    <div class="stepLine">
      <input type="text" id="step1Left" class="stepInput" placeholder="linke Seite">
      <span class="eqSign">=</span>
      <input type="text" id="step1Right" class="stepInput" placeholder="rechte Seite">
      <button data-step="1" class="checkBtn">prüfen</button>
    </div>
    <div id="step1Fb" class="fb"></div>
  </div>

  <!-- Schritt 2 -->
  <div class="stepRow">
    <div class="stepTitle">2. Gleichartige Glieder zusammenfassen</div>
    <div class="stepLine">
      <input type="text" id="step2Left" class="stepInput" placeholder="linke Seite">
      <span class="eqSign">=</span>
      <input type="text" id="step2Right" class="stepInput" placeholder="rechte Seite">
      <button data-step="2" class="checkBtn">prüfen</button>
    </div>
    <div id="step2Fb" class="fb"></div>
  </div>

  <!-- Schritt 3 -->
  <div class="stepRow">
    <div class="stepTitle">3. x-Glieder auf eine Seite bringen</div>
    <div class="stepLine">
      <input type="text" id="step3Left" class="stepInput" placeholder="linke Seite">
      <span class="eqSign">=</span>
      <input type="text" id="step3Right" class="stepInput" placeholder="rechte Seite">
      <button data-step="3" class="checkBtn">prüfen</button>
    </div>
    <div id="step3Fb" class="fb"></div>
  </div>

  <!-- Schritt 4 -->
  <div class="stepRow">
    <div class="stepTitle">4. Zahlen auf die andere Seite bringen</div>
    <div class="stepLine">
      <input type="text" id="step4Left" class="stepInput" placeholder="linke Seite">
      <span class="eqSign">=</span>
      <input type="text" id="step4Right" class="stepInput" placeholder="rechte Seite">
      <button data-step="4" class="checkBtn">prüfen</button>
    </div>
    <div id="step4Fb" class="fb"></div>
  </div>

  <!-- Schritt 5 -->
  <div class="stepRow">
    <div class="stepTitle">5. Nach x auflösen</div>
    <div class="stepLine">
      <input type="text" id="step5Left" class="stepInput" placeholder="linke Seite">
      <span class="eqSign">=</span>
      <input type="text" id="step5Right" class="stepInput" placeholder="rechte Seite">
      <button data-step="5" class="checkBtn">prüfen</button>
    </div>
    <div id="step5Fb" class="fb"></div>
  </div>

  <button id="newEqBtn">Neue Gleichung</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const steps = [
    { left: step1Left, right: step1Right, fb: step1Fb },
    { left: step2Left, right: step2Right, fb: step2Fb },
    { left: step3Left, right: step3Right, fb: step3Fb },
    { left: step4Left, right: step4Right, fb: step4Fb },
    { left: step5Left, right: step5Right, fb: step5Fb }
  ];

  let originalEq = "";
  let trueSolution = null;

  function normalizeMinus(s){
    return s.replace(/−/g,"-");
  }

  function parseSide(str){
    str = normalizeMinus(str).replace(/\s+/g,"");
    if(str==="" ) return {cx:0,c0:0};
    if(str[0] !== "+" && str[0] !== "-") str = "+"+str;
    const terms = str.match(/[+\-][^+\-]+/g) || [];
    let cx=0, c0=0;
    for(const t of terms){
      const sign = t[0]==="-"?-1:1;
      const body=t.slice(1);
      if(body.includes("x")){
        const coeffStr=body.replace("x","");
        const coeff = coeffStr===""?1:parseFloat(coeffStr);
        cx += sign*coeff;
      } else {
        const n=parseFloat(body);
        if(!isNaN(n)) c0+=sign*n;
      }
    }
    return {cx,c0};
  }

  function canonEq(eq){
    const p=eq.split("=");
    return {
      ax: parseSide(p[0]).cx - parseSide(p[1]).cx,
      b:  parseSide(p[0]).c0 - parseSide(p[1]).c0
    };
  }

  function equivalent(a,b){
    const c1=canonEq(a), c2=canonEq(b);
    const {ax:a1,b:b1}=c1, {ax:a2,b:b2}=c2;
    if(a1===0&&b1===0&&a2===0&&b2===0) return true;
    return a1*b2===a2*b1;
  }

  function solveCanon(c){
    if(c.ax===0) return null;
    return -c.b/c.ax;
  }

  function parseSolution(L,R){
    const l=L.replace(/\s+/g,""), r=R.replace(/\s+/g,"");
    if(l==="x" && /^-?\d+$/.test(r)) return parseInt(r);
    if(r==="x" && /^-?\d+$/.test(l)) return parseInt(l);
    return null;
  }

  // ----- Aufgabe generieren -----
  function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a;}

  function decompose(k){
    if(k===0) return [];
    let parts=[], rest=k, count=2+Math.floor(Math.random()*2);
    for(let i=0;i<count-1;i++){
      const r=Math.max(1,Math.floor(Math.abs(rest)));
      const v=randInt(-r,r);
      parts.push(v);
      rest-=v;
    }
    parts.push(rest);
    return parts.filter(x=>x!==0);
  }

  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
  }

  function sideToString(terms){
    let out="", first=true;
    for(const t of terms){
      const sign=t.coef>=0?"+":"-", abs=Math.abs(t.coef);
      const piece = t.kind==="x" ? (abs===1?"x":abs+"x") : abs;
      if(first){ out+=(sign==="+"?piece:"-"+piece); first=false; }
      else out+=" "+sign+" "+piece;
    }
    return out||"0";
  }

  function generateEquation(){
    let x0;
    do{x0=randInt(-5,5);}while(x0===0);

    let A,C;
    do{A=randInt(-6,6);}while(A===0);
    do{C=randInt(-6,6);}while(C===0||C===A);

    const B=randInt(-20,20);
    const D=A*x0 + B - C*x0;

    const L=[...decompose(A).map(k=>({kind:"x",coef:k})),
             ...decompose(B).map(k=>({kind:"c",coef:k}))];

    const R=[...decompose(C).map(k=>({kind:"x",coef:k})),
             ...decompose(D).map(k=>({kind:"c",coef:k}))];

    shuffle(L); shuffle(R);

    return {
      eq: sideToString(L)+" = "+sideToString(R),
      solution:x0
    };
  }

  function newEquation(){
    const g=generateEquation();
    originalEq=g.eq;
    trueSolution=g.solution;

    equation.textContent="Aufgabe: "+originalEq;

    steps.forEach(s=>{
      s.left.value="";
      s.right.value="";
      s.fb.textContent="";
      s.fb.className="fb";
    });

    steps[0].left.focus();
  }

  // ---- Prüfen ----
  function checkStep(i){
    const s=steps[i];
    const L=s.left.value.trim();
    const R=s.right.value.trim();

    if(!L||!R){
      s.fb.textContent="Bitte beide Seiten eingeben.";
      s.fb.className="fb err";
      return;
    }

    if(i===4){
      const sol=parseSolution(L,R);
      if(sol===null){
        s.fb.textContent="Format: x = Zahl";
        s.fb.className="fb err";
        return;
      }
      if(sol===trueSolution){
        s.fb.textContent="✔ richtig!";
        s.fb.className="fb ok";
      } else {
        s.fb.textContent="✘ falsch.";
        s.fb.className="fb err";
      }
      return;
    }

    const eq=L+" = "+R;
    if(equivalent(originalEq,eq)){
      s.fb.textContent="✔ richtig.";
      s.fb.className="fb ok";
    } else {
      s.fb.textContent="✘ nicht äquivalent.";
      s.fb.className="fb err";
    }
  }

  document.querySelectorAll(".checkBtn").forEach(btn=>{
    btn.addEventListener("click",()=>{
      checkStep(parseInt(btn.dataset.step)-1);
    });
  });

  steps.forEach((s,i)=>{
    [s.left,s.right].forEach(inp=>{
      inp.addEventListener("keydown",e=>{
        if(e.key==="Enter") checkStep(i);
      });
    });
  });

  newEqBtn.addEventListener("click",newEquation);

  newEquation();
});
</script>

</body>
</html>
