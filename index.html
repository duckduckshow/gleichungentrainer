<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gleichungstrainer</title>
<style>

  body{
    font-family:system-ui,Arial,sans-serif;
    margin:0;
    padding:18px;
    text-align:center;
    background:linear-gradient(to bottom right,#eef2ff,#e0f7fa);
    font-size:18px;
  }

  #equation{
    font-size:1.9em;
    margin:0 auto 20px;
    font-weight:bold;
  }

  #stepsBox{
    margin:0 auto;
    max-width:1100px;
    background:#ffffffcc;
    border-radius:16px;
    padding:22px;
    text-align:left;
  }

  .stepRow{
    margin:24px 0 26px;
  }

  .stepTitle{
    font-weight:bold;
    color:#007bff;
    font-size:1.2em;
    margin-bottom:10px;
  }

  .stepLine{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:nowrap;
  }

  .stepInputLeft,
  .stepInputRight{
    flex:1;
    padding:10px 12px;
    font-size:1.15em;
    border-radius:10px;
    border:1px solid #888;
    font-family:monospace;
    min-width:160px;
  }

  .eqSign{
    font-size:1.6em;
    font-weight:bold;
  }

  .checkEqBtn, .checkFormBtn{
    background:#007bff;
    color:white;
    border:none;
    padding:10px 12px;
    border-radius:10px;
    cursor:pointer;
    font-size:1em;
    white-space:nowrap;
  }
  .checkEqBtn:hover, .checkFormBtn:hover{
    background:#0056b3;
  }

  .eqFormLabel{
    font-size:1.4em;
    font-weight:bold;
    margin-left:10px;
  }

  .eqFormInput{
    width:90px;
    padding:8px;
    font-size:1.15em;
    border-radius:10px;
    border:1px solid #888;
    font-family:monospace;
  }

  .fb{
    font-size:1em;
    margin-top:4px;
    min-height:1.4em;
  }
  .ok{color:#2e7d32;}
  .err{color:#c62828;}

  #newEqBtn{
    display:block;
    margin:20px auto 0;
    padding:12px 26px;
    font-size:1.3em;
    border:none;
    background:#007bff;
    color:white;
    border-radius:10px;
    cursor:pointer;
  }
  #newEqBtn:hover{
    background:#0056b3;
  }

</style>
</head>
<body>

<div id="equation">Lade Aufgabe ...</div>

<div id="stepsBox"></div>

<button id="newEqBtn">Neue Gleichung</button>

<script>

document.addEventListener("DOMContentLoaded", () => {

  /* ------------------------------
     Hilfsfunktionen für Mathe
  ------------------------------ */

  function normalizeMinus(s){
    return s.replace(/−/g,"-");
  }

  function parseSide(str){
    str = normalizeMinus(str).replace(/\s+/g,"");
    if(str==="" ) return {cx:0,c0:0};
    if(!["+","-"].includes(str[0])) str = "+"+str;
    const terms = str.match(/[+\-][^+\-]+/g) || [];
    let cx=0, c0=0;
    for(const t of terms){
      const sign = t[0]==="-"?-1:1;
      const body=t.slice(1);
      if(body.includes("x")){
        const coeffStr = body.replace("x","");
        const coeff = coeffStr===""?1:parseFloat(coeffStr);
        cx += sign*coeff;
      } else {
        const n=parseFloat(body);
        if(!isNaN(n)) c0+=sign*n;
      }
    }
    return {cx,c0};
  }

  function canonEq(eq){
    const p=eq.split("=");
    const L=parseSide(p[0]);
    const R=parseSide(p[1]);
    return {ax:L.cx-R.cx, b:L.c0-R.c0};
  }

  function equivalent(eq1,eq2){
    const c1=canonEq(eq1), c2=canonEq(eq2);
    const {ax:a1,b:b1}=c1, {ax:a2,b:b2}=c2;
    if(a1===0&&b1===0&&a2===0&&b2===0) return true;
    return a1*b2===a2*b1;
  }

  function solveCanon(c){
    if(c.ax===0) return null;
    return -c.b/c.ax;
  }

  /* ------------------------------
     Aufgabengenerator
  ------------------------------ */

  function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a;}

  function decompose(k){
    if(k===0) return [];
    let parts=[], rest=k, count=2+Math.floor(Math.random()*2);
    for(let i=0;i<count-1;i++){
      const r=Math.max(1,Math.floor(Math.abs(rest)));
      const v=randInt(-r,r);
      parts.push(v); rest-=v;
    }
    parts.push(rest);
    return parts.filter(x=>x!==0);
  }

  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
  }

  function sideToString(terms){
    let out="", first=true;
    for(const t of terms){
      const sign=t.coef>=0?"+":"-", abs=Math.abs(t.coef);
      const piece=t.kind==="x"?(abs===1?"x":abs+"x") : abs;
      if(first){ out+=(sign==="+"?piece:"-"+piece); first=false; }
      else out+=" "+sign+" "+piece;
    }
    return out||"0";
  }

  function generateEquation(){
    let x0;
    do{x0=randInt(-5,5);}while(x0===0);

    let A,C;
    do{A=randInt(-6,6);}while(A===0);
    do{C=randInt(-6,6);}while(C===0||C===A);

    const B=randInt(-20,20);
    const D=A*x0+B - C*x0;

    const L=[...decompose(A).map(k=>({kind:"x",coef:k})),
             ...decompose(B).map(k=>({kind:"c",coef:k}))];

    const R=[...decompose(C).map(k=>({kind:"x",coef:k})),
             ...decompose(D).map(k=>({kind:"c",coef:k}))];

    shuffle(L); shuffle(R);

    return {
      eq: sideToString(L)+" = "+sideToString(R),
      solution:x0
    };
  }

  /* -----------------------------------
     Äquivalenzumformung prüfen
  ----------------------------------- */

  function parseOperation(opStr){
    // akzeptiert: | +3, | -2x, | :5, | *4
    const cleaned = opStr.replace(/\s+/g,"");
    if(!cleaned.startsWith("|")) return null;

    const op = cleaned.slice(1); // z.B. +3, -2x, :5, *4
    if(op.length<2) return null;

    const type = op[0]; // + - : *
    const val  = op.slice(1);

    if(!["+","-","*","x","/","÷",":","*"].includes(type))
      if(!["+","-","*","/","x",":","*"].includes(type)) return null;

    return {type, val};
  }

  function applyOperationToSide(sideStr, op){
    // "2x + 3" mit op = {type:"+", val:"3"}
    const value = op.val.includes("x") ? op.val : parseFloat(op.val);
    const parsed = parseSide(sideStr);

    if(op.type==="+" && !isNaN(value)){
      parsed.c0 += value;
    } else if(op.type==="-" && !isNaN(value)){
      parsed.c0 -= value;
    } else if(op.type===":" || op.type=="/"){
      parsed.cx /= parseFloat(op.val);
      parsed.c0 /= parseFloat(op.val);
    } else if(op.type==="*" || op.type==="x"){
      parsed.cx *= parseFloat(op.val);
      parsed.c0 *= parseFloat(op.val);
    } else if(op.type==="+" && op.val.includes("x")){
      parsed.cx += parseFloat(op.val);
    } else if(op.type==="-" && op.val.includes("x")){
      parsed.cx -= parseFloat(op.val);
    }

    return parsed.cx + "x + " + parsed.c0;
  }

  function eqStringFromParsed(p){
    let result = "";
    if(p.cx!==0){
      result += (p.cx===1?"x":p.cx+"x");
    }
    if(p.c0>0){
      result += (p.cx!==0?" + ":"") + p.c0;
    }
    if(p.c0<0){
      result += " - " + Math.abs(p.c0);
    }
    return result || "0";
  }

  function applyOperationToEquation(eqStr, op){
    const parts = eqStr.split("=");
    const L = parseSide(parts[0]);
    const R = parseSide(parts[1]);

    function applyToParsed(p){
      const clone={cx:p.cx,c0:p.c0};
      if(op.type==="+" && !isNaN(op.val)){
        clone.c0 += parseFloat(op.val);
      } else if(op.type==="+" && op.val.includes("x")){
        clone.cx += parseFloat(op.val);
      } else if(op.type==="-" && !isNaN(op.val)){
        clone.c0 -= parseFloat(op.val);
      } else if(op.type==="-" && op.val.includes("x")){
        clone.cx -= parseFloat(op.val);
      } else if(op.type===":"){
        clone.cx /= parseFloat(op.val);
        clone.c0 /= parseFloat(op.val);
      } else if(op.type==="*" || op.type==="x"){
        clone.cx *= parseFloat(op.val);
        clone.c0 *= parseFloat(op.val);
      }
      return clone;
    }

    const newL = applyToParsed(L);
    const newR = applyToParsed(R);

    return eqStringFromParsed(newL) + " = " + eqStringFromParsed(newR);
  }

  /* -----------------------------------
     UI erzeugen
  ----------------------------------- */

  const stepsBox = document.getElementById("stepsBox");
  const equationEl = document.getElementById("equation");

  const stepNames = [
    "Gleichartige Glieder ordnen",
    "Gleichartige Glieder zusammenfassen",
    "x-Glieder auf eine Seite bringen",
    "Zahlen auf die andere Seite bringen",
    "Nach x auflösen"
  ];

  let originalEq = "";
  let trueSolution = null;

  function renderSteps(){
    stepsBox.innerHTML = "";

    stepNames.forEach((name,i)=>{
      const row = document.createElement("div");
      row.className = "stepRow";

      row.innerHTML = `
        <div class="stepTitle">${i+1}. ${name}</div>

        <div class="stepLine">

          <input type="text" class="stepInputLeft" id="L${i}" placeholder="linke Seite">
          <span class="eqSign">=</span>
          <input type="text" class="stepInputRight" id="R${i}" placeholder="rechte Seite">

          <button class="checkEqBtn" data-step="${i}">Gleichung prüfen</button>

          <span class="eqFormLabel">|</span>
          <input type="text" class="eqFormInput" id="F${i}">
          <button class="checkFormBtn" data-step="${i}">Umformung prüfen</button>

        </div>

        <div class="fb" id="fbEq${i}"></div>
        <div class="fb" id="fbForm${i}"></div>
      `;

      stepsBox.appendChild(row);
    });
  }

  renderSteps();

  /* -----------------------------------
     Prüfungen
  ----------------------------------- */

  function checkEquation(step){
    const left = document.getElementById(`L${step}`).value.trim();
    const right = document.getElementById(`R${step}`).value.trim();
    const fb = document.getElementById(`fbEq${step}`);

    if(!left || !right){
      fb.textContent="Bitte beide Seiten eingeben.";
      fb.className="fb err";
      return;
    }

    const eq = left + " = " + right;

    if(equivalent(originalEq,eq)){
      fb.textContent="✔ richtig (äquivalent).";
      fb.className="fb ok";
    } else {
      fb.textContent="✘ nicht äquivalent.";
      fb.className="fb err";
    }
  }

  function checkForm(step){
    const opStr = document.getElementById(`F${step}`).value.trim();
    const fb = document.getElementById(`fbForm${step}`);

    const op = parseOperation(opStr);
    if(!op){
      fb.textContent="✘ Ungültige Operation. Beispiel: | -3, | +2x, | :5";
      fb.className="fb err";
      return;
    }

    // Operation prüfen mit nächster Zeile
    const newLeft = document.getElementById(`L${step}`).value.trim();
    const newRight = document.getElementById(`R${step}`).value.trim();

    if(!newLeft || !newRight){
      fb.textContent="Bitte zuerst die neue Gleichung eingeben.";
      fb.className="fb err";
      return;
    }

    const newEq = newLeft + " = " + newRight;
    const computed = applyOperationToEquation(step===0?originalEq : originalEq, op);

    if(equivalent(computed,newEq)){
      fb.textContent="✔ Umformung korrekt angewandt.";
      fb.className="fb ok";
    } else {
      fb.textContent="✘ Neue Zeile passt nicht zur angegebenen Umformung.";
      fb.className="fb err";
    }
  }

  /* -----------------------------------
     Events
  ----------------------------------- */

  stepsBox.addEventListener("click",e=>{
    if(e.target.classList.contains("checkEqBtn")){
      const step = parseInt(e.target.dataset.step);
      checkEquation(step);
    }
    if(e.target.classList.contains("checkFormBtn")){
      const step = parseInt(e.target.dataset.step);
      checkForm(step);
    }
  });

  /* -----------------------------------
     Neue Gleichung
  ----------------------------------- */

  function newEquation(){
    const g = generateEquation();
    originalEq = g.eq;
    trueSolution = g.solution;

    equationEl.textContent = "Aufgabe: " + originalEq;

    renderSteps();
  }

  document.getElementById("newEqBtn").addEventListener("click", newEquation);

  newEquation();

});
</script>

</body>
</html>
