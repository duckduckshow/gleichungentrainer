<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gleichungstrainer</title>

<style>
  body{
    font-family:system-ui,Arial,sans-serif;
    margin:0;
    padding:12px;
    text-align:center;
    background:linear-gradient(to bottom right,#eef2ff,#e0f7fa);
    font-size:18px;
  }

  #topBar{
    max-width:1100px;
    margin:0 auto 4px;
    display:flex;
    justify-content:flex-end;
    align-items:center;
  }

  #counterBox{
    font-size:1.1em;
    font-weight:bold;
    color:#333;
  }

  #stepsBox{
    margin:0 auto;
    max-width:1100px;
    background:#ffffffcc;
    border-radius:16px;
    padding:16px;
    text-align:left;
  }

  .eqRow{
    margin-bottom:14px;
  }

  /* Aufgabenzeile */
  .eqTextLeft,
  .eqTextRight{
    flex:1;
    padding:10px 15px;
    font-size:1.5em;
    font-weight:bold;
    font-family:monospace;
    border-radius:8px;
    box-sizing:border-box;
  }
  .eqTextLeft{text-align:right;}
  .eqTextRight{text-align:left;}

  /* Schrittblöcke */
  .stepRow{
    margin:12px 0 18px;
  }

  .stepTitle{
    font-weight:bold;
    color:#007bff;
    font-size:1.1em;
    margin-bottom:4px;
  }

  .stepLine{
    display:flex;
    align-items:center;
    gap:8px;
  }

  /* Gleichungsfelder — jetzt ALLE ident breit */
  .stepInputLeft,
  .stepInputRight{
    flex:1;
    min-width:150px;
    padding:8px 10px;
    font-size:1.15em;
    border-radius:8px;
    border:1px solid #888;
    font-family:monospace;
  }

  /* DUMMY-Feld für Zeile 1 und 5 */
  .formDummy{
    width:70px;           /* exakt wie eqFormInput */
    height:0px;
    opacity:0;
  }

  .eqSign{
    font-size:1.6em;
    font-weight:bold;
  }

  .checkEqBtn, .checkFormBtn{
    background:#007bff;
    color:white;
    border:none;
    padding:8px 12px;
    border-radius:8px;
    cursor:pointer;
    font-size:0.95em;
    white-space:nowrap;
  }
  .checkEqBtn:hover, .checkFormBtn:hover{
    background:#0056b3;
  }

  .eqFormLabel{
    font-size:1.3em;
    font-weight:bold;
    margin-left:6px;
  }

  .eqFormInput{
    width:70px;
    padding:6px;
    font-size:1.05em;
    border-radius:8px;
    border:1px solid #888;
    font-family:monospace;
  }

  /* Rückmeldungen */
  .fb{
    font-size:0.95em;
    margin-top:2px;
    min-height:1.2em;
  }
  .ok{color:#2e7d32;}
  .err{color:#c62828;}

  /* NEU für rechtsbündige Umformungs-Kommentare */
  .formFbWrap{
    display:flex;
    justify-content:flex-end;
  }

  #bottomBar{
    max-width:1100px;
    margin:12px auto 0;
    display:flex;
    align-items:center;
    justify-content:space-between;
  }

  #solutionBox{
    display:none;
    font-size:1.4em;
    font-weight:bold;
    color:#007bff;
    text-align:left;
  }

  #newEqBtn{
    padding:10px 22px;
    font-size:1.2em;
    border:none;
    background:#007bff;
    color:white;
    border-radius:10px;
    cursor:pointer;
  }

  #newEqBtn:hover{
    background:#0056b3;
  }
</style>
</head>
<body>

<div id="topBar">
  <div id="counterBox">Gelöst: 0</div>
</div>

<div id="stepsBox"></div>

<div id="bottomBar">
  <div id="solutionBox"></div>
  <button id="newEqBtn">Neue Gleichung</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* MATHE-FUNKTIONEN */
  function normalizeMinus(s){ return s.replace(/−/g,"-"); }

  function parseSide(str){
    str = normalizeMinus(str).replace(/\s+/g,"");
    if(str==="") return {cx:0,c0:0};
    if(!["+","-"].includes(str[0])) str = "+"+str;
    const terms=str.match(/[+\-][^+\-]+/g)||[];
    let cx=0,c0=0;
    for(const t of terms){
      const sign=t[0]==="-"?-1:1;
      const body=t.slice(1);
      if(body.includes("x")){
        let c=body.replace("x","");
        if(c==="") c="1";
        cx+=sign*parseFloat(c);
      }else{
        const n=parseFloat(body);
        if(!isNaN(n)) c0+=sign*n;
      }
    }
    return {cx,c0};
  }

  function canonEq(eq){
    const p=eq.split("=");
    const L=parseSide(p[0]);
    const R=parseSide(p[1]);
    return {ax:L.cx-R.cx,b:L.c0-R.c0};
  }

  function equivalent(eq1,eq2){
    const c1=canonEq(eq1), c2=canonEq(eq2);
    return (c1.ax*c2.b === c2.ax*c1.b);
  }

  function solveCanon(c){
    if(c.ax===0) return null;
    return -c.b/c.ax;
  }

  /* AUFGABEN-GENERATOR */
  function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
  function decompose(k){
    if(k===0) return [];
    let rest=k, list=[];
    const count=2+Math.floor(Math.random()*2);
    for(let i=0;i<count-1;i++){
      const v=randInt(-Math.abs(rest),Math.abs(rest));
      list.push(v);
      rest-=v;
    }
    list.push(rest);
    return list.filter(x=>x!==0);
  }
  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
  }
  function sideToString(arr){
    let out="",first=true;
    for(const t of arr){
      const s=t.coef>=0?"+":"-";
      const abs=Math.abs(t.coef);
      const text=t.kind==="x"?(abs===1?"x":abs+"x"):abs;
      if(first){
        out+=(s==="+"?text:"-"+text);
        first=false;
      } else {
        out+=" "+s+" "+text;
      }
    }
    return out||"0";
  }
  function generateEquation(){
    let x0; do{x0=randInt(-5,5);}while(x0===0);
    let A; do{A=randInt(-6,6);}while(A===0);
    let C; do{C=randInt(-6,6);}while(C===0||C===A);
    const B=randInt(-20,20);
    const D=A*x0 + B - C*x0;
    const L=[...decompose(A).map(k=>({kind:"x",coef:k})),
             ...decompose(B).map(k=>({kind:"c",coef:k}))];
    const R=[...decompose(C).map(k=>({kind:"x",coef:k})),
             ...decompose(D).map(k=>({kind:"c",coef:k}))];
    shuffle(L); shuffle(R);
    return {eq:sideToString(L)+" = "+sideToString(R), solution:x0};
  }

  /* UI */
  const stepsBox=document.getElementById("stepsBox");
  const solutionBox=document.getElementById("solutionBox");
  const counterBox=document.getElementById("counterBox");

  const stepNames=[
    "Gleichartige Glieder ordnen",
    "Gleichartige Glieder zusammenfassen",
    "x-Glieder auf eine Seite bringen",
    "Zahlen auf die andere Seite bringen",
    "Nach x auflösen"
  ];

  let originalEq="", origLeft="", origRight="", trueSolution=null;
  let solvedCurrent=false, solvedCount=0;

  function renderSteps(){
    stepsBox.innerHTML="";
    solutionBox.style.display="none";

    /* Aufgabenzeile */
    const eq=document.createElement("div");
    eq.className="eqRow";
    eq.innerHTML=`
      <div class="stepLine">
        <span class="eqTextLeft">${origLeft}</span>
        <span class="eqSign">=</span>
        <span class="eqTextRight">${origRight}</span>
      </div>
    `;
    stepsBox.appendChild(eq);

    /* Schritte */
    stepNames.forEach((name,i)=>{
      const hasForm=(i>=1 && i<=3);
      const row=document.createElement("div");
      row.className="stepRow";

      row.innerHTML=`
        <div class="stepTitle">${i+1}. ${name}</div>

        <div class="stepLine">
          <input type="text" class="stepInputLeft" id="L${i}" placeholder="linke Seite">
          <span class="eqSign">=</span>
          <input type="text" class="stepInputRight" id="R${i}" placeholder="rechte Seite">

          <button class="checkEqBtn" data-step="${i}">Zeile prüfen</button>

          ${hasForm ?
            `
            <span class="eqFormLabel">|</span>
            <input type="text" class="eqFormInput" id="F${i}">
            <button class="checkFormBtn" data-step="${i}">Prüfen</button>
            `
            :
            `<span class="formDummy"></span>`
          }
        </div>

        <div class="fb" id="fbEq${i}"></div>

        ${hasForm ?
          `<div class="formFbWrap"><div class="fb" id="fbForm${i}"></div></div>`
          : ``
        }
      `;

      stepsBox.appendChild(row);
    });
  }

  /* Gleichungsprüfung */
  function checkEquation(step){
    const L=document.getElementById(`L${step}`).value.trim();
    const R=document.getElementById(`R${step}`).value.trim();
    const fb=document.getElementById(`fbEq${step}`);
    if(!L||!R){
      fb.textContent="Beide Seiten eingeben.";
      fb.className="fb err";
      return;
    }
    if(equivalent(originalEq,L+" = "+R)){
      fb.textContent="✔ äquivalent zur Ausgangsgleichung.";
      fb.className="fb ok";
      if(step===4 && !solvedCurrent){
        solvedCurrent=true;
        solvedCount++;
        counterBox.textContent="Gelöst: "+solvedCount;
        solutionBox.style.display="block";
        solutionBox.textContent=`L = { ${trueSolution} }`;
      }
    } else {
      fb.textContent="✘ nicht äquivalent zur Ausgangsgleichung.";
      fb.className="fb err";
    }
  }

  /* Umformungs-Prüfung */
  function parseUserOp(stepIndex,raw){
    let s=raw.replace(/\s+/g,"");
    if(!s) return null;
    const t=s[0], valStrRaw=s.slice(1);
    if(!"+-*/:".includes(t)) return null;

    let valStr=valStrRaw, hasX=false;
    if(stepIndex===1){
      if(!valStr.includes("x")) return null;
      hasX=true;
      valStr=valStr.replace("x","");
      if(valStr==="") valStr="1";
      if(valStr==="+"||valStr==="-") valStr+="1";
    }else{
      if(valStr.includes("x")) return null;
    }

    const v=parseFloat(valStr);
    if(isNaN(v)||v===0) return null;

    return {type:t, val:v, hasX};
  }
  function expectedOpForStep(i,eq){
    const[L,R]=eq.split("=");
    const l=parseSide(L), r=parseSide(R);

    if(i===1){
      if(l.cx===0||r.cx===0) return null;
      const del=(Math.abs(l.cx)<=Math.abs(r.cx)? -l.cx : -r.cx);
      return {type:(del>0?"+":"-"), val:Math.abs(del), hasX:true};
    }
    if(i===2){
      const s=l.cx!==0?l:(r.cx!==0?r:null);
      if(!s||s.c0===0) return null;
      const del=-s.c0;
      return {type:(del>0?"+":"-"), val:Math.abs(del), hasX:false};
    }
    if(i===3){
      const s=l.cx!==0?l:(r.cx!==0?r:null);
      if(!s) return null;
      return {type:":", val:s.cx, hasX:false};
    }
    return null;
  }
  function opsEqual(u,e){
    const ut=(u.type==="/" ? ":" : u.type);
    const et=(e.type==="/" ? ":" : e.type);
    return ut===et && u.hasX===e.hasX && Math.abs(u.val-e.val)<1e-9;
  }
  function checkForm(step){
    const fb=document.getElementById(`fbForm${step}`);
    const raw=document.getElementById(`F${step}`).value.trim();
    if(!raw){
      fb.textContent="Bitte eine Umformung eingeben.";
      fb.className="fb err";
      return;
    }

    const L=document.getElementById(`L${step}`).value.trim();
    const R=document.getElementById(`R${step}`).value.trim();
    if(!L||!R){
      fb.textContent="Gib zuerst die Gleichung ein.";
      fb.className="fb err";
      return;
    }

    const eq=L+" = "+R;
    const u=parseUserOp(step,raw);
    if(!u){
      fb.textContent="Das ist nicht die richtige Umformung für den nächsten Schritt!";
      fb.className="fb err";
      return;
    }

    const e=expectedOpForStep(step,eq);
    if(!e){
      fb.textContent="Das ist nicht die richtige Umformung für den nächsten Schritt!";
      fb.className="fb err";
      return;
    }

    if(opsEqual(u,e)){
      fb.textContent="Das ist die richtige Umformung!";
      fb.className="fb ok";
    } else {
      fb.textContent="Das ist nicht die richtige Umformung für den nächsten Schritt!";
      fb.className="fb err";
    }
  }

  /* Events */
  stepsBox.addEventListener("click",e=>{
    if(e.target.classList.contains("checkEqBtn")) checkEquation(+e.target.dataset.step);
    if(e.target.classList.contains("checkFormBtn")) checkForm(+e.target.dataset.step);
  });

  /* Neue Gleichung */
  function newEquation(){
    const g=generateEquation();
    originalEq=g.eq;
    const parts=g.eq.split("=");
    origLeft=parts[0].trim();
    origRight=parts[1].trim();
    trueSolution=solveCanon(canonEq(g.eq));
    solvedCurrent=false;
    solutionBox.style.display="none";
    renderSteps();
  }
  document.getElementById("newEqBtn").addEventListener("click",newEquation);

  newEquation();
});
</script>

</body>
</html>
