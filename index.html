<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gleichungstrainer – Schritt für Schritt</title>
<style>
  body{
    font-family:system-ui,Arial,sans-serif;
    margin:0;
    padding:20px;
    text-align:center;
    background:linear-gradient(to bottom right,#eef2ff,#e0f7fa);
  }
  h1{margin:10px 0;font-size:1.8em;color:#333}
  #equation{font-size:1.5em;margin:15px auto;}
  .main-layout{
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    align-items:flex-start;
    gap:20px;
    max-width:1100px;
    margin:0 auto;
  }
  #stepsBox{
    flex:1 1 480px;
    max-width:600px;
    text-align:left;
    background:#ffffffb8;
    border-radius:12px;
    padding:12px 16px;
  }
  #schemaBox{
    flex:0 1 260px;
    max-width:320px;
    text-align:left;
    background:#ffffff80;
    border-radius:12px;
    padding:12px 16px;
    font-size:0.95em;
  }
  .stepRow{
    margin:6px 0 10px;
  }
  .stepTitle{
    font-weight:bold;
    color:#007bff;
    font-size:0.96em;
  }
  .stepHint{
    font-size:0.9em;
    color:#444;
    margin-bottom:3px;
  }
  .stepInput{
    width:100%;
    max-width:100%;
    box-sizing:border-box;
    padding:6px 8px;
    font-size:1em;
    border-radius:8px;
    border:1px solid #aaa;
    font-family:monospace;
  }
  .stepInput:focus{outline:none;border-color:#007bff;}
  .btnRow{
    margin-top:4px;
  }
  button{
    background:#007bff;
    color:white;
    border:none;
    padding:6px 12px;
    margin:2px 4px 0 0;
    border-radius:8px;
    cursor:pointer;
    font-size:0.9em;
  }
  button:hover{background:#0056b3;}
  .fb{
    font-size:0.9em;
    margin-top:3px;
  }
  .ok{color:#2e7d32;}
  .err{color:#c62828;}
  #newEqBtn{
    margin-top:10px;
  }
</style>
</head>
<body>

<h1>Gleichungstrainer – lineare Gleichungen</h1>

<div id="equation">Lade Aufgabe ...</div>

<div class="main-layout">
  <div id="stepsBox">
    <div class="stepRow">
      <div class="stepTitle">1. Gleichartige Glieder ordnen</div>
      <div class="stepHint">Nur umstellen: erst alle x-Terme, dann die Zahlen (ohne Klammern).</div>
      <input type="text" id="step1Input" class="stepInput" placeholder="z.B. 4x - 2x + 2 + 5 = 3x + 4x - 9 + 11">
      <div class="btnRow">
        <button data-step="1" class="checkBtn">Zeile 1 prüfen</button>
      </div>
      <div id="step1Fb" class="fb"></div>
    </div>

    <div class="stepRow">
      <div class="stepTitle">2. Gleichartige Glieder zusammenfassen</div>
      <div class="stepHint">x-Terme und Zahlen auf jeder Seite zusammenfassen.</div>
      <input type="text" id="step2Input" class="stepInput" placeholder="z.B. 2x + 7 = 7x + 2">
      <div class="btnRow">
        <button data-step="2" class="checkBtn">Zeile 2 prüfen</button>
      </div>
      <div id="step2Fb" class="fb"></div>
    </div>

    <div class="stepRow">
      <div class="stepTitle">3. x-Glieder auf eine Seite bringen</div>
      <div class="stepHint">Alle x-Terme auf die Seite mit dem größeren x-Koeffizienten bringen.</div>
      <input type="text" id="step3Input" class="stepInput" placeholder="z.B. 2x - 7x = 2 - 7">
      <div class="btnRow">
        <button data-step="3" class="checkBtn">Zeile 3 prüfen</button>
      </div>
      <div id="step3Fb" class="fb"></div>
    </div>

    <div class="stepRow">
      <div class="stepTitle">4. Zahlen auf die andere Seite bringen</div>
      <div class="stepHint">Nur noch eine Seite mit x, andere Seite nur Zahlen.</div>
      <input type="text" id="step4Input" class="stepInput" placeholder="z.B. -5x = -5">
      <div class="btnRow">
        <button data-step="4" class="checkBtn">Zeile 4 prüfen</button>
      </div>
      <div id="step4Fb" class="fb"></div>
    </div>

    <div class="stepRow">
      <div class="stepTitle">5. Nach x auflösen</div>
      <div class="stepHint">Endergebnis in der Form <b>x = ...</b>.</div>
      <input type="text" id="step5Input" class="stepInput" placeholder="z.B. x = 1">
      <div class="btnRow">
        <button data-step="5" class="checkBtn">Zeile 5 prüfen</button>
      </div>
      <div id="step5Fb" class="fb"></div>
    </div>

    <div class="stepRow">
      <div class="stepTitle">6. Probe</div>
      <div class="stepHint">Setze x ein und berechne beide Seiten. Schreibe z.B. <code>19 = 19</code>.</div>
      <input type="text" id="probeInput" class="stepInput" placeholder="z.B. 19 = 19">
      <div class="btnRow">
        <button id="probeCheckBtn">Probe prüfen</button>
      </div>
      <div id="probeFb" class="fb"></div>
    </div>

    <button id="newEqBtn">Neue Gleichung</button>
  </div>

  <div id="schemaBox">
    <strong>Schematische Schritte (wie im Beispiel):</strong>
    <ol>
      <li><b>gleichartige Glieder ordnen</b><br><span style="font-size:0.9em;">x-Terme zusammen, Zahlen zusammen.</span></li>
      <li><b>gleichartige Glieder zusammenfassen</b><br><span style="font-size:0.9em;">x-Terme und Zahlen je Seite vereinfachen.</span></li>
      <li><b>x-Glieder auf eine Seite bringen</b><br><span style="font-size:0.9em;">auf die Seite mit größerem x-Koeffizienten.</span></li>
      <li><b>Zahlen auf die andere Seite bringen</b></li>
      <li><b>Nach x auflösen</b></li>
      <li><b>Probe nicht vergessen!</b></li>
    </ol>
    <p style="font-size:0.85em;color:#555;">
      Du darfst auch Schritte überspringen – jede Zeile wird nur auf
      <b>algebraische Richtigkeit</b> geprüft.
    </p>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const equationEl = document.getElementById("equation");

  const stepInputs = [
    document.getElementById("step1Input"),
    document.getElementById("step2Input"),
    document.getElementById("step3Input"),
    document.getElementById("step4Input"),
    document.getElementById("step5Input")
  ];
  const stepFeedbacks = [
    document.getElementById("step1Fb"),
    document.getElementById("step2Fb"),
    document.getElementById("step3Fb"),
    document.getElementById("step4Fb"),
    document.getElementById("step5Fb")
  ];
  const probeInput = document.getElementById("probeInput");
  const probeFb = document.getElementById("probeFb");

  const checkButtons = document.querySelectorAll(".checkBtn");
  const newEqBtn = document.getElementById("newEqBtn");
  const probeCheckBtn = document.getElementById("probeCheckBtn");

  // --------- Mathe-Hilfsfunktionen ----------

  function normalizeMinus(s){
    return s.replace(/−/g,"-");
  }

  // Seite wie "4x+2-3x-5" -> {cx, c0}
  function parseSide(str){
    str = normalizeMinus(str).replace(/\s+/g,"");
    if(str==="") return {cx:0,c0:0};
    if(str[0] !== "+" && str[0] !== "-") str = "+"+str;
    const terms = str.match(/[+\-][^+\-]+/g) || [];
    let cx = 0, c0 = 0;
    for(const t of terms){
      const sign = t[0]==="-"?-1:1;
      const body = t.slice(1);
      if(body.includes("x")){
        const coeffStr = body.replace("x","");
        const coeff = coeffStr==="" ? 1 : parseFloat(coeffStr);
        cx += sign * coeff;
      }else{
        const n = parseFloat(body);
        if(!isNaN(n)) c0 += sign * n;
      }
    }
    return {cx,c0};
  }

  // "LHS = RHS" -> {ax,b} mit ax*x + b = 0
  function canonEq(eqStr){
    const parts = eqStr.split("=");
    if(parts.length !== 2) return null;
    const L = parseSide(parts[0]);
    const R = parseSide(parts[1]);
    return {ax: L.cx - R.cx, b: L.c0 - R.c0};
  }

  // sind zwei Gleichungen äquivalent? (gleiche Lösungsmenge)
  function equivalent(eq1, eq2){
    const c1 = canonEq(eq1);
    const c2 = canonEq(eq2);
    if(!c1 || !c2) return false;
    const a1=c1.ax, b1=c1.b;
    const a2=c2.ax, b2=c2.b;
    // beide 0x + 0 = 0
    if(a1===0 && b1===0 && a2===0 && b2===0) return true;
    // proportional?
    return (a1*b2 === a2*b1);
  }

  function solveFromCanon(c){
    if(!c || c.ax===0) return null;
    return -c.b / c.ax;
  }

  // x = Zahl oder Zahl = x
  function parseSolutionLine(eqStr){
    const parts = eqStr.replace(/\s+/g,"").split("=");
    if(parts.length!==2) return null;
    if(parts[0]==="x" && /^-?\d+$/.test(parts[1])) return parseInt(parts[1],10);
    if(parts[1]==="x" && /^-?\d+$/.test(parts[0])) return parseInt(parts[0],10);
    return null;
  }

  // Prüfe, ob auf einer Seite alle x-Terme vor den Zahlen stehen
  function varsThenNumbers(sideStr){
    let s = normalizeMinus(sideStr).replace(/\s+/g,"");
    if(s==="") return true;
    if(s[0] !== "+" && s[0] !== "-") s = "+"+s;
    const terms = s.match(/[+\-][^+\-]+/g) || [];
    let seenNumber=false;
    for(const t of terms){
      const body = t.slice(1);
      const isX = body.includes("x");
      if(!isX) seenNumber=true;
      if(isX && seenNumber) return false; // x nach Zahl
    }
    return true;
  }

  // Probe prüfen (z.B. "19 = 19")
  function checkProbeString(str, solutionValue, originalEq){
    const partsOrig = originalEq.split("=");
    const valSide = sideStr => {
      let s = normalizeMinus(sideStr).replace(/\s+/g,"");
      if(s==="") return 0;
      if(s[0] !== "+" && s[0] !== "-") s = "+"+s;
      const terms = s.match(/[+\-][^+\-]+/g) || [];
      let sum = 0;
      for(const t of terms){
        const sign = t[0]==="-"?-1:1;
        const body = t.slice(1);
        if(body.includes("x")){
          const coeffStr = body.replace("x","");
          const coeff = coeffStr===""?1:parseFloat(coeffStr);
          sum += sign * coeff * solutionValue;
        }else{
          const n = parseFloat(body);
          if(!isNaN(n)) sum += sign * n;
        }
      }
      return sum;
    };
    const expectedL = valSide(partsOrig[0]);
    const expectedR = valSide(partsOrig[1]);

    const userParts = str.replace(/\s+/g,"").split("=");
    if(userParts.length!==2) return false;
    const nL = parseFloat(userParts[0]);
    const nR = parseFloat(userParts[1]);
    if(isNaN(nL) || isNaN(nR)) return false;
    return (nL===expectedL && nR===expectedR);
  }

  // --------- Aufgabengenerator (unsortierte Terme) ----------

  function randInt(min,max){
    return Math.floor(Math.random()*(max-min+1))+min;
  }

  function decompose(k){
    if(k===0) return [];
    const parts=[];
    let rest=k;
    const count = 2 + Math.floor(Math.random()*2); // 2 oder 3 Terme
    for(let i=0;i<count-1;i++){
      const range = Math.max(1,Math.floor(Math.abs(rest)));
      const val = randInt(-range,range);
      parts.push(val);
      rest -= val;
    }
    parts.push(rest);
    return parts.filter(v=>v!==0);
  }

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
  }

  function isVarsFirst(terms){
    let seenNum=false;
    for(const t of terms){
      if(t.kind==="c") seenNum=true;
      if(t.kind==="x" && seenNum) return false;
    }
    return true;
  }

  function sideToString(terms){
    let out="";
    let first=true;
    for(const t of terms){
      const coef=t.coef;
      if(coef===0) continue;
      const sign = coef>=0?"+":"-";
      const abs = Math.abs(coef);
      let piece;
      if(t.kind==="x"){
        piece = (abs===1?"x":abs+"x");
      }else{
        piece = String(abs);
      }
      if(first){
        out += (sign==="+"?piece:("-"+piece));
        first=false;
      }else{
        out += " "+sign+" "+piece;
      }
    }
    return out || "0";
  }

  function generateEquation(){
    const x0 = (()=>{let v;do{v=randInt(-5,5);}while(v===0);return v;})();

    let A, C;
    do{A=randInt(-6,6);}while(A===0);
    do{C=randInt(-6,6);}while(C===0 || C===A);

    const B = randInt(-20,20);
    const D = A*x0 + B - C*x0;

    const xPartsL = decompose(A);
    const xPartsR = decompose(C);
    const cPartsL = decompose(B);
    const cPartsR = decompose(D);

    let termsL=[],termsR=[];
    xPartsL.forEach(k=>termsL.push({kind:"x",coef:k}));
    cPartsL.forEach(k=>termsL.push({kind:"c",coef:k}));
    xPartsR.forEach(k=>termsR.push({kind:"x",coef:k}));
    cPartsR.forEach(k=>termsR.push({kind:"c",coef:k}));

    shuffle(termsL);
    shuffle(termsR);

    // Sicherstellen: mindestens eine Seite NICHT "x vor Zahlen"
    if(isVarsFirst(termsL) && isVarsFirst(termsR)){
      let idx = termsL.findIndex(t=>t.kind==="c");
      if(idx>0){
        const tmp=termsL[0];
        termsL[0]=termsL[idx];
        termsL[idx]=tmp;
      }
    }

    const lhs = sideToString(termsL);
    const rhs = sideToString(termsR);

    return {equation: lhs+" = "+rhs, solution:x0};
  }

  // --------- Trainer-Logik ----------

  let originalEq = "";
  let canonOriginal = null;
  let trueSolution = null;

  function setFb(el,text,ok){
    el.textContent=text;
    el.className = "fb " + (ok?"ok":"err");
  }

  function newEquation(){
    const gen = generateEquation();
    originalEq = gen.equation;
    canonOriginal = canonEq(originalEq);
    trueSolution = solveFromCanon(canonOriginal);

    equationEl.textContent = "Aufgabe:  " + originalEq;

    // Felder leeren
    stepInputs.forEach(inp=>inp.value="");
    stepFeedbacks.forEach(fb=>{fb.textContent="";fb.className="fb";});
    probeInput.value="";
    probeFb.textContent="";
    probeFb.className="fb";
    stepInputs[0].focus();
  }

  function checkStep(stepIndex){
    const input = stepInputs[stepIndex].value.trim();
    const fb = stepFeedbacks[stepIndex];

    if(!input){
      setFb(fb,"Bitte gib eine Gleichung in dieser Zeile ein.",false);
      return;
    }

    // Schritt 5: Lösung in Form x = ...
    if(stepIndex===4){
      const sol = parseSolutionLine(input);
      if(sol === null){
        setFb(fb,"Gib die Lösung in der Form x = ... an (z.B. x = 3).",false);
        return;
      }
      if(trueSolution !== null && sol === trueSolution){
        setFb(fb,`✅ Lösung korrekt: x = ${sol}`,true);
      }else{
        setFb(fb,"❌ Diese Lösung ist nicht korrekt.",false);
      }
      return;
    }

    // Schritte 1–4: allgemeine Gleichung prüfen
    if(!input.includes("=")){
      setFb(fb,"Bitte eine Gleichung mit '=' eingeben.",false);
      return;
    }

    if(!equivalent(originalEq,input)){
      setFb(fb,"❌ Diese Zeile ist nicht äquivalent zur Ausgangsgleichung. Überprüfe deine Umformung.",false);
      return;
    }

    // Spezielle Hinweise für Schritt 1 (Ordnen)
    if(stepIndex===0){
      let hint="";
      if(/[()]/.test(input)){
        hint+=" Hinweis: Beim Ordnen bitte keine Klammern verwenden, nur Glieder umstellen.";
      }
      const parts = input.split("=");
      if(!varsThenNumbers(parts[0]) || !varsThenNumbers(parts[1])){
        hint+=" Hinweis: Schreibe zuerst alle x-Terme, dann die Zahlen.";
      }
      setFb(fb,"✅ Zeile 1 ist algebraisch richtig."+hint,true);
    }else{
      setFb(fb,`✅ Zeile ${stepIndex+1} ist algebraisch richtig.`,true);
    }
  }

  function checkProbe(){
    const s = probeInput.value.trim();
    if(!s){
      setFb(probeFb,"Bitte gib eine Probe ein, z.B. 19 = 19.",false);
      return;
    }
    if(trueSolution===null){
      setFb(probeFb,"Fehler: Lösung unbekannt.",false);
      return;
    }
    const ok = checkProbeString(s,trueSolution,originalEq);
    if(ok){
      setFb(probeFb,"✅ Probe stimmt – Gleichung korrekt gelöst.",true);
    }else{
      setFb(probeFb,"❌ Diese Probe passt nicht zur Gleichung bzw. zur Lösung. Rechne die Seiten noch einmal nach.",false);
    }
  }

  // Events
  checkButtons.forEach(btn=>{
    btn.addEventListener("click",()=>{
      const step = parseInt(btn.getAttribute("data-step"),10)-1;
      checkStep(step);
    });
  });

  stepInputs.forEach((inp,idx)=>{
    inp.addEventListener("keydown",e=>{
      if(e.key==="Enter") checkStep(idx);
    });
  });

  newEqBtn.addEventListener("click",newEquation);
  probeCheckBtn.addEventListener("click",checkProbe);
  probeInput.addEventListener("keydown",e=>{
    if(e.key==="Enter") checkProbe();
  });

  // Start
  newEquation();
});
</script>

</body>
</html>
