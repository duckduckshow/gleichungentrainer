<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gleichungstrainer</title>

<style>
  body{
    font-family:system-ui,Arial,sans-serif;
    margin:0;
    padding:12px;
    text-align:center;
    background:linear-gradient(to bottom right,#eef2ff,#e0f7fa);
    font-size:18px;
  }

  #topBar{
    max-width:1100px;
    margin:0 auto 4px;
    display:flex;
    justify-content:flex-end;
    align-items:center;
  }

  #counterBox{
    font-size:1em;
    font-weight:bold;
    color:#333;
  }

  #stepsBox{
    margin:0 auto;
    max-width:1100px;
    background:#ffffffcc;
    border-radius:16px;
    padding:16px;
    text-align:left;
  }

  .eqRow{
    margin-bottom:18px;
  }

  .stepRow{
    margin:12px 0 22px;
  }

  .stepTitle{
    font-weight:bold;
    color:#007bff;
    font-size:1.1em;
    margin-bottom:4px;
  }

  .stepLine{
    display:flex;
    align-items:center;
    gap:8px;
  }

  /* Aufgabenzeile exakt wie Eingabefelder */
  .eqTextLeft,
  .eqTextRight{
    flex:1;
    min-width:150px;
    padding:8px 10px;
    font-size:1.3em;
    font-weight:bold;
    font-family:monospace;
    border:1px solid transparent;
    border-radius:8px;
    box-sizing:border-box;
  }

  .eqTextLeft{ text-align:right; }
  .eqTextRight{ text-align:left; }

  .stepInputLeft,
  .stepInputRight{
    flex:1;
    min-width:150px;
    padding:8px 10px;
    font-size:1.1em;
    border-radius:8px;
    border:1px solid #888;
    font-family:monospace;
  }

  .eqSign{
    font-size:1.4em;
    font-weight:bold;
  }

  .checkEqBtn, .checkFormBtn{
    background:#007bff;
    color:white;
    border:none;
    padding:8px 10px;
    border-radius:8px;
    cursor:pointer;
    font-size:0.95em;
    white-space:nowrap;
  }

  .checkEqBtn:hover, .checkFormBtn:hover{
    background:#0056b3;
  }

  .eqFormLabel{
    font-size:1.3em;
    font-weight:bold;
    margin-left:6px;
  }

  .eqFormInput{
    width:70px;
    padding:6px;
    font-size:1.05em;
    border-radius:8px;
    border:1px solid #888;
    font-family:monospace;
  }

  .formDummy{
    display:flex;
    width:160px;      /* exakt gleiche Breite wie | F Pruefen */
    opacity:0;        /* unsichtbar aber nimmt Platz ein */
  }

  .fb{
    font-size:0.95em;
    margin-top:4px;
    min-height:1.2em;
    text-align:right;        /* rechtsbündig wie gewünscht */
  }

  .ok{color:#2e7d32;}
  .err{color:#c62828;}

  #bottomBar{
    max-width:1100px;
    margin:10px auto 0;
    display:flex;
    align-items:center;
    justify-content:space-between;
  }

  #solutionBox{
    display:none;
    font-size:1.4em;
    font-weight:bold;
    color:#007bff;
    text-align:left;
  }

  #newEqBtn{
    padding:10px 22px;
    font-size:1.2em;
    border:none;
    background:#007bff;
    color:white;
    border-radius:10px;
    cursor:pointer;
  }

  #newEqBtn:hover{
    background:#0056b3;
  }
</style>
</head>
<body>

<div id="topBar">
  <div id="counterBox">Gelöst: 0</div>
</div>

<div id="stepsBox"></div>

<div id="bottomBar">
  <div id="solutionBox"></div>
  <button id="newEqBtn">Neue Gleichung</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* ---------- Mathe ---------- */

  const normalizeMinus = s => s.replace(/−/g,"-");

  function parseSide(str){
    str = normalizeMinus(str).replace(/\s+/g,"");
    if(str==="" ) return {cx:0,c0:0};
    if(!["+","-"].includes(str[0])) str = "+"+str;
    const terms = str.match(/[+\-][^+\-]+/g) || [];
    let cx=0,c0=0;
    for(const t of terms){
      const sign = t[0]==="-"?-1:1;
      const body=t.slice(1);
      if(body.includes("x")){
        const cs=body.replace("x","");
        const coeff = cs===""?1:parseFloat(cs);
        cx += sign*coeff;
      }else{
        const n=parseFloat(body);
        if(!isNaN(n)) c0+=sign*n;
      }
    }
    return {cx,c0};
  }

  function canonEq(eq){
    const [L,R]=eq.split("=");
    const pL=parseSide(L), pR=parseSide(R);
    return {ax:pL.cx-pR.cx, b:pL.c0-pR.c0};
  }

  function equivalent(a,b){
    const c1=canonEq(a), c2=canonEq(b);
    return (c1.ax*c2.b === c2.ax*c1.b);
  }

  function solveCanon(c){
    if(c.ax===0) return null;
    return -c.b/c.ax;
  }

  /* ---------- Generator ---------- */

  const ri=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;

  function decompose(k){
    if(k===0) return [];
    let arr=[], rest=k, count=2+Math.floor(Math.random()*2);
    for(let i=0;i<count-1;i++){
      const r=Math.max(1,Math.floor(Math.abs(rest)));
      const v=ri(-r,r);
      arr.push(v); rest-=v;
    }
    arr.push(rest);
    return arr.filter(n=>n!==0);
  }

  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
  }

  function sideString(terms){
    let out="",first=true;
    for(const t of terms){
      const sign=t.coef>=0?"+":"-";
      const abs=Math.abs(t.coef);
      const part = (t.kind==="x" ? (abs===1?"x":abs+"x") : abs);
      if(first){
        out += (sign==="+"?part:"-"+part);
        first=false;
      }else{
        out += " "+sign+" "+part;
      }
    }
    return out||"0";
  }

  function generateEquation(){
    let x0;
    do{x0=ri(-5,5);}while(x0===0);

    let A,C;
    do{A=ri(-6,6);}while(A===0);
    do{C=ri(-6,6);}while(C===0||C===A);

    const B=ri(-20,20);
    const D=A*x0 + B - C*x0;

    let L=[...decompose(A).map(k=>({kind:"x",coef:k})),
           ...decompose(B).map(k=>({kind:"c",coef:k}))];

    let R=[...decompose(C).map(k=>({kind:"x",coef:k})),
           ...decompose(D).map(k=>({kind:"c",coef:k}))];

    shuffle(L); shuffle(R);

    return {
      eq: sideString(L)+" = "+sideString(R),
      sol: x0
    };
  }

  /* ---------- UI ---------- */

  const stepsBox=document.getElementById("stepsBox");
  const solutionBox=document.getElementById("solutionBox");
  const counterBox=document.getElementById("counterBox");

  const stepNames=[
    "Gleichartige Glieder ordnen",
    "Gleichartige Glieder zusammenfassen",
    "x-Glieder auf eine Seite bringen",
    "Zahlen auf die andere Seite bringen",
    "Nach x auflösen"
  ];

  let originalEq="";
  let origLeft="", origRight="";
  let trueSolution=null;
  let solvedCount=0;
  let solvedCurrent=false;

  function renderSteps(){
    stepsBox.innerHTML="";
    solutionBox.style.display="none";

    // Aufgabenzeile
    stepsBox.innerHTML = `
      <div class="eqRow">
        <div class="stepLine">
          <span class="eqTextLeft">${origLeft}</span>
          <span class="eqSign">=</span>
          <span class="eqTextRight">${origRight}</span>
        </div>
      </div>
    `;

    // Schritte
    stepNames.forEach((name,i)=>{
      const hasForm=(i>=1 && i<=3);

      const row=document.createElement("div");
      row.className="stepRow";

      row.innerHTML=`
        <div class="stepTitle">${i+1}. ${name}</div>
        <div class="stepLine">
          <input class="stepInputLeft" id="L${i}" placeholder="linke Seite">
          <span class="eqSign">=</span>
          <input class="stepInputRight" id="R${i}" placeholder="rechte Seite">

          <button class="checkEqBtn" data-step="${i}">Zeile prüfen</button>

          ${hasForm ? `
            <span class="eqFormLabel">|</span>
            <input class="eqFormInput" id="F${i}">
            <button class="checkFormBtn" data-step="${i}">Prüfen</button>
          `
          :
            `<div class="formDummy"></div>`
          }
        </div>

        <div class="fb" id="fbEq${i}"></div>
        ${hasForm ? `<div class="fb" id="fbForm${i}"></div>` : ""}
      `;

      stepsBox.appendChild(row);
    });
  }

  /* ---------- Prüfen ---------- */

  function checkEquation(step){
    const L=document.getElementById(`L${step}`).value.trim();
    const R=document.getElementById(`R${step}`).value.trim();
    const fb=document.getElementById(`fbEq${step}`);

    if(!L||!R){
      fb.textContent="Beide Seiten eingeben.";
      fb.className="fb err";
      return;
    }

    const eq=L+" = "+R;

    if(equivalent(originalEq,eq)){
      fb.textContent="✔ äquivalent zur Ausgangsgleichung.";
      fb.className="fb ok";

      if(step===4 && !solvedCurrent){
        solvedCurrent=true;
        solvedCount++;
        counterBox.textContent="Gelöst: "+solvedCount;

        solutionBox.style.display="block";
        solutionBox.textContent=`L = { ${trueSolution} }`;
      }

    }else{
      fb.textContent="✘ nicht äquivalent zur Ausgangsgleichung.";
      fb.className="fb err";
    }
  }

  function parseUserOp(stepIndex, raw){
    let s=raw.replace(/\s+/g,"");
    if(!s) return null;

    const type=s[0];
    let valStr=s.slice(1);

    if(!"+-*/:".includes(type)) return null;
    let hasX=false;

    if(stepIndex===1){
      if(!valStr.includes("x")) return null;
      hasX=true;
      valStr=valStr.replace("x","");
      if(valStr==="") valStr="1";
      if(valStr==="+"||valStr==="-") valStr+="1";
    }else{
      if(valStr.includes("x")) return null;
    }

    const val=parseFloat(valStr);
    if(isNaN(val)||val===0) return null;

    return {type,val,hasX};
  }

  function expectedOpForStep(stepIndex, eqStr){
    const [Lstr, Rstr] = eqStr.split("=");
    const L = parseSide(Lstr);
    const R = parseSide(Rstr);

    // ----------------------------------------------------
    // Schritt 2 (Index 1): x-Glieder zusammenfassen
    // Regel: Die Seite mit dem KLEINEREN x-Koeffizienten
    //        wird ausgeglichen (Vergleich MIT Vorzeichen!)
    // ----------------------------------------------------
    if (stepIndex === 1) {

        // beide Seiten brauchen x-Terme, sonst keine Umformung sinnvoll
        if (L.cx === 0 || R.cx === 0) return null;

        let del;

        // Linke Seite hat kleineren Koeffizienten (mit Vorzeichenvergleich)
        if (L.cx < R.cx) {
            del = -L.cx;   // linke Seite angleichen
        } 
        else {
            del = -R.cx;   // rechte Seite angleichen
        }

        if (del === 0) return null;

        return {
            type: (del > 0 ? "+" : "-"),
            val: Math.abs(del),
            hasX: true
        };
    }

    // ----------------------------------------------------
    // Schritt 3 (Index 2): Zahlen auf die andere Seite
    // ----------------------------------------------------
    if (stepIndex === 2) {
        const side = (L.cx !== 0 ? L : (R.cx !== 0 ? R : null));
        if (!side || side.c0 === 0) return null;

        const del = -side.c0;

        return {
            type: (del > 0 ? "+" : "-"),
            val: Math.abs(del),
            hasX: false
        };
    }

    // ----------------------------------------------------
    // Schritt 4 (Index 3): Durch x-Koeffizient dividieren
    // ----------------------------------------------------
    if (stepIndex === 3) {
        const side = (L.cx !== 0 ? L : (R.cx !== 0 ? R : null));
        if (!side || side.cx === 0) return null;

        return {
            type: ":",
            val: side.cx,
            hasX: false
        };
    }

    return null;
}

  function opsEqual(a,b){
    if(!a||!b) return false;
    const ta=(a.type==="/" ? ":" : a.type);
    const tb=(b.type==="/" ? ":" : b.type);
    return (ta===tb && a.hasX===b.hasX && Math.abs(a.val-b.val)<1e-9);
  }

  function checkForm(step){
    const fb=document.getElementById(`fbForm${step}`);
    const raw=document.getElementById(`F${step}`).value.trim();
    if(!raw){
      fb.textContent="Bitte eine Umformung eingeben.";
      fb.className="fb err";
      return;
    }

    const L=document.getElementById(`L${step}`).value.trim();
    const R=document.getElementById(`R${step}`).value.trim();
    if(!L||!R){
      fb.textContent="Gib zuerst die Gleichung ein.";
      fb.className="fb err";
      return;
    }

    const eq=L+" = "+R;

    const user=parseUserOp(step,raw);
    const exp=expectedOp(step,eq);

    if(user && exp && opsEqual(user,exp)){
      fb.textContent="Das ist die richtige Umformung!";
      fb.className="fb ok";
    }else{
      fb.textContent="Das ist nicht die richtige Umformung für den nächsten Schritt!";
      fb.className="fb err";
    }
  }

  /* ---------- Events ---------- */

  stepsBox.addEventListener("click", e=>{
    if(e.target.classList.contains("checkEqBtn")){
      checkEquation(parseInt(e.target.dataset.step,10));
    }
    if(e.target.classList.contains("checkFormBtn")){
      checkForm(parseInt(e.target.dataset.step,10));
    }
  });

  /* ---------- neue Gleichung ---------- */

  function newEquation(){
    const g=generateEquation();
    originalEq=g.eq;
    [origLeft,origRight]=g.eq.split("=").map(x=>x.trim());
    trueSolution=g.sol;
    solvedCurrent=false;
    solutionBox.style.display="none";
    renderSteps();
  }

  document.getElementById("newEqBtn").addEventListener("click", newEquation);

  newEquation();

});
</script>

</body>
</html>
